{% extends 'app_layout.html' %}
{% load static %}

{% block title %}Edit Profile Field Permissions - {{ profile.name }}{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    .module-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease;
    }
    .module-card:hover {
        transform: translateY(-2px);
    }
    .module-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 1rem 1.5rem;
        border-radius: 15px 15px 0 0;
    }
    .field-item {
        padding: 0.75rem 1.5rem;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s ease;
    }
    .field-item:hover {
        background-color: #f8f9fa;
    }
    .field-item:last-child {
        border-bottom: none;
        border-radius: 0 0 15px 15px;
    }
    .field-name {
        font-weight: 500;
        color: #495057;
    }
    .field-type {
        font-size: 0.85rem;
        color: #6c757d;
        margin-left: 0.5rem;
    }
    .permission-toggle {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider {
        background-color: #28a745;
    }
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    .permission-summary {
        background-color: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .progress-bar-custom {
        height: 8px;
        border-radius: 4px;
    }
    .bulk-actions {
        background-color: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transform: translateY(-100px);
        transition: transform 0.3s ease;
        z-index: 1000;
    }
    .save-indicator.show {
        transform: translateY(0);
    }
    .field-search {
        background-color: white;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        padding: 0.5rem 1rem;
        margin-bottom: 1.5rem;
        font-size: 1rem;
    }
    .field-search:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        transition: transform 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
    }
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">{{ profile.name }}</h1>
                <p class="mb-0 opacity-75">{{ profile.description|default:"Configure field-level permissions for this profile" }}</p>
            </div>
            <div class="col-md-4 text-md-end">
                <a href="{% url 'authentication:field_permissions_dashboard' %}" class="btn btn-light btn-lg">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" id="totalFieldsCount">{{ total_fields }}</div>
            <div class="stat-label">Total Fields</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-success" id="viewableFieldsCount">{{ viewable_fields }}</div>
            <div class="stat-label">Viewable Fields</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-primary" id="editableFieldsCount">{{ editable_fields }}</div>
            <div class="stat-label">Editable Fields</div>
        </div>
        <div class="stat-card">
            <div class="stat-number text-warning" id="pendingChangesCount">0</div>
            <div class="stat-label">Pending Changes</div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-3">Bulk Actions</h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="bulkToggle('view', true)">
                        <i class="fas fa-eye"></i> Enable All View
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="bulkToggle('edit', true)">
                        <i class="fas fa-edit"></i> Enable All Edit
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="bulkToggle('all', false)">
                        <i class="fas fa-ban"></i> Disable All
                    </button>
                </div>
            </div>
            <div class="col-md-6">
                <h5 class="mb-3">Quick Search</h5>
                <input type="text" id="fieldSearch" class="field-search w-100" placeholder="Search fields by name or type...">
            </div>
        </div>
    </div>

    <!-- Save Indicator -->
    <div id="saveIndicator" class="save-indicator">
        <i class="fas fa-check-circle"></i> Changes saved successfully!
    </div>

    <!-- Module Cards -->
    <div id="moduleContainer">
        {% for module_data in modules_data %}
        <div class="module-card" data-module="{{ module_data.module.name }}">
            <div class="module-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-0">
                            <i class="fas fa-folder-open text-primary"></i>
                            {{ module_data.module.display_name }} Module
                        </h4>
                        <small class="text-muted">{{ module_data.total_fields }} fields</small>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-success" onclick="moduleToggle('{{ module_data.module.name }}', 'view', true)">
                                <i class="fas fa-eye"></i> All View
                            </button>
                            <button type="button" class="btn btn-outline-primary" onclick="moduleToggle('{{ module_data.module.name }}', 'edit', true)">
                                <i class="fas fa-edit"></i> All Edit
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="moduleToggle('{{ module_data.module.name }}', 'all', false)">
                                <i class="fas fa-ban"></i> None
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Module Progress -->
                <div class="mt-2">
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">View Progress</small>
                            <div class="progress progress-bar-custom">
                                {% widthratio module_data.viewable_fields module_data.total_fields 100 as view_percent %}
                                <div class="progress-bar bg-success" style="width: {{ view_percent }}%"></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Edit Progress</small>
                            <div class="progress progress-bar-custom">
                                <div class="progress-bar bg-primary" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="module-fields">
                {% for model_name, permissions in module_data.models.items %}
                    <div class="model-group">
                        <h6 class="text-muted mt-3 mb-2">{{ model_name }}</h6>
                        {% for permission in permissions %}
                        <div class="field-item" data-field="{{ permission.field_name }}" data-type="text">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <div class="field-name">
                                        {{ permission.field_name|capfirst }}
                                    </div>
                                    <div class="field-type">
                                        <span class="badge badge-secondary">{{ model_name }}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="permission-toggle">
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">View:</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" 
                                                       class="permission-checkbox view-permission"
                                                       data-field="{{ permission.field_name }}" 
                                                       data-module="{{ module_data.module.name }}"
                                                       data-permission="view"
                                                       {% if permission.can_view %}checked{% endif %}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2">Edit:</span>
                                            <label class="toggle-switch">
                                                <input type="checkbox" 
                                                       class="permission-checkbox edit-permission"
                                                       data-field="{{ permission.field_name }}" 
                                                       data-module="{{ module_data.module.name }}"
                                                       data-permission="edit"
                                                       {% if permission.can_edit %}checked{% endif %}>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <button type="button" class="btn btn-sm btn-outline-info" onclick="showFieldDetails('{{ permission.field_name }}', '{{ module_data.module.name }}')">
                                                <i class="fas fa-cog"></i> Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-inbox fa-3x mb-3"></i>
            <h4>No Fields Found</h4>
            <p>No fields are currently configured for this profile.</p>
        </div>
        {% endfor %}
    </div>

    <!-- Save Changes Button -->
    <div class="text-center mt-4 mb-5">
        <button id="saveChangesBtn" class="btn btn-gradient btn-lg" style="display: none;" onclick="saveAllChanges()">
            <i class="fas fa-save"></i> Save All Changes (<span id="changesCounter">0</span>)
        </button>
    </div>
</div>

<!-- Field Details Modal -->
<div class="modal fade" id="fieldDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Field Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="fieldDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveFieldDetails()">Save Field Settings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let pendingChanges = {};
let originalState = {};

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    initializePermissions();
    setupEventListeners();
    captureOriginalState();
});

function initializePermissions() {
    // Store original states
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        const key = getChangeKey(checkbox);
        originalState[key] = checkbox.checked;
    });
}

function setupEventListeners() {
    // Permission checkbox changes
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            handlePermissionChange(this);
        });
    });

    // Search functionality
    document.getElementById('fieldSearch').addEventListener('input', function() {
        filterFields(this.value);
    });
}

function captureOriginalState() {
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        const key = getChangeKey(checkbox);
        originalState[key] = checkbox.checked;
    });
}

function getChangeKey(checkbox) {
    return `${checkbox.dataset.module}-${checkbox.dataset.field}-${checkbox.dataset.permission}`;
}

function handlePermissionChange(checkbox) {
    const key = getChangeKey(checkbox);
    const originalValue = originalState[key];
    const currentValue = checkbox.checked;
    
    if (originalValue !== currentValue) {
        pendingChanges[key] = {
            profile_id: {{ profile.id }},
            field_name: checkbox.dataset.field,
            module: checkbox.dataset.module,
            permission_type: checkbox.dataset.permission,
            value: currentValue,
            original: originalValue
        };
    } else {
        delete pendingChanges[key];
    }
    
    // Auto-dependencies
    if (checkbox.dataset.permission === 'edit' && currentValue) {
        // Auto-enable view when edit is enabled
        const viewCheckbox = document.querySelector(
            `.view-permission[data-field="${checkbox.dataset.field}"][data-module="${checkbox.dataset.module}"]`
        );
        if (viewCheckbox && !viewCheckbox.checked) {
            viewCheckbox.checked = true;
            handlePermissionChange(viewCheckbox);
        }
    } else if (checkbox.dataset.permission === 'view' && !currentValue) {
        // Auto-disable edit when view is disabled
        const editCheckbox = document.querySelector(
            `.edit-permission[data-field="${checkbox.dataset.field}"][data-module="${checkbox.dataset.module}"]`
        );
        if (editCheckbox && editCheckbox.checked) {
            editCheckbox.checked = false;
            handlePermissionChange(editCheckbox);
        }
    }
    
    updateUI();
}

function updateUI() {
    const changesCount = Object.keys(pendingChanges).length;
    
    // Update counters
    document.getElementById('pendingChangesCount').textContent = changesCount;
    document.getElementById('changesCounter').textContent = changesCount;
    
    // Show/hide save button
    const saveBtn = document.getElementById('saveChangesBtn');
    if (changesCount > 0) {
        saveBtn.style.display = 'inline-block';
    } else {
        saveBtn.style.display = 'none';
    }
    
    // Update field counts
    updateFieldCounts();
    updateModuleProgress();
}

function updateFieldCounts() {
    const viewableFields = document.querySelectorAll('.view-permission:checked').length;
    const editableFields = document.querySelectorAll('.edit-permission:checked').length;
    
    document.getElementById('viewableFieldsCount').textContent = viewableFields;
    document.getElementById('editableFieldsCount').textContent = editableFields;
}

function updateModuleProgress() {
    document.querySelectorAll('.module-card').forEach(moduleCard => {
        const moduleName = moduleCard.dataset.module;
        const fields = moduleCard.querySelectorAll('.field-item');
        const viewChecked = moduleCard.querySelectorAll('.view-permission:checked').length;
        const editChecked = moduleCard.querySelectorAll('.edit-permission:checked').length;
        
        const viewPercentage = (viewChecked / fields.length) * 100;
        const editPercentage = (editChecked / fields.length) * 100;
        
        moduleCard.querySelector('.progress-bar.bg-success').style.width = viewPercentage + '%';
        moduleCard.querySelector('.progress-bar.bg-primary').style.width = editPercentage + '%';
    });
}

function bulkToggle(permissionType, enabled) {
    const checkboxes = [];
    
    if (permissionType === 'view') {
        checkboxes.push(...document.querySelectorAll('.view-permission'));
    } else if (permissionType === 'edit') {
        checkboxes.push(...document.querySelectorAll('.edit-permission'));
    } else if (permissionType === 'all') {
        checkboxes.push(...document.querySelectorAll('.permission-checkbox'));
    }
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked !== enabled) {
            checkbox.checked = enabled;
            handlePermissionChange(checkbox);
        }
    });
}

function moduleToggle(moduleName, permissionType, enabled) {
    const moduleCard = document.querySelector(`[data-module="${moduleName}"]`);
    const checkboxes = [];
    
    if (permissionType === 'view') {
        checkboxes.push(...moduleCard.querySelectorAll('.view-permission'));
    } else if (permissionType === 'edit') {
        checkboxes.push(...moduleCard.querySelectorAll('.edit-permission'));
    } else if (permissionType === 'all') {
        checkboxes.push(...moduleCard.querySelectorAll('.permission-checkbox'));
    }
    
    checkboxes.forEach(checkbox => {
        if (checkbox.checked !== enabled) {
            checkbox.checked = enabled;
            handlePermissionChange(checkbox);
        }
    });
}

function filterFields(searchTerm) {
    const searchLower = searchTerm.toLowerCase();
    
    document.querySelectorAll('.field-item').forEach(fieldItem => {
        const fieldName = fieldItem.querySelector('.field-name').textContent.toLowerCase();
        const fieldType = fieldItem.dataset.type.toLowerCase();
        
        const matches = fieldName.includes(searchLower) || fieldType.includes(searchLower);
        fieldItem.style.display = matches ? 'block' : 'none';
    });
    
    // Hide empty modules
    document.querySelectorAll('.module-card').forEach(moduleCard => {
        const visibleFields = moduleCard.querySelectorAll('.field-item:not([style*="display: none"])');
        moduleCard.style.display = visibleFields.length > 0 ? 'block' : 'none';
    });
}

function saveAllChanges() {
    if (Object.keys(pendingChanges).length === 0) {
        return;
    }
    
    const changes = Object.values(pendingChanges);
    
    fetch('{% url "authentication:bulk_update_field_permissions" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ changes: changes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update original state
            changes.forEach(change => {
                const key = `${change.module}-${change.field_name}-${change.permission_type}`;
                originalState[key] = change.value;
            });
            
            // Clear pending changes
            pendingChanges = {};
            updateUI();
            
            // Show success indicator
            showSaveIndicator();
        } else {
            alert('Error saving changes: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving changes');
    });
}

function showSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.add('show');
    
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 3000);
}

function showFieldDetails(fieldName, moduleName) {
    // This would load detailed field configuration
    const modalContent = document.getElementById('fieldDetailsContent');
    modalContent.innerHTML = `
        <div class="row">
            <div class="col-12">
                <h6>Field: ${fieldName}</h6>
                <p><strong>Module:</strong> ${moduleName}</p>
                
                <h6 class="mt-3">Visibility Settings</h6>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="visibleInList">
                    <label class="form-check-label" for="visibleInList">Visible in List Views</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="visibleInDetail">
                    <label class="form-check-label" for="visibleInDetail">Visible in Detail Views</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="visibleInForms">
                    <label class="form-check-label" for="visibleInForms">Visible in Forms</label>
                </div>
                
                <h6 class="mt-3">Data Filters</h6>
                <div class="form-group">
                    <label>Filter Type</label>
                    <select class="form-select" id="filterType">
                        <option value="">No Filter</option>
                        <option value="user_based">User-based Filter</option>
                        <option value="role_based">Role-based Filter</option>
                        <option value="department_based">Department-based Filter</option>
                    </select>
                </div>
            </div>
        </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('fieldDetailsModal'));
    modal.show();
}

function saveFieldDetails() {
    // Implementation for saving detailed field settings
    const modal = bootstrap.Modal.getInstance(document.getElementById('fieldDetailsModal'));
    modal.hide();
    
    showSaveIndicator();
}

// Initialize page
updateUI();
</script>
{% endblock %}