{% extends 'app_layout.html' %}
{% load static %}

{% block title %}Data Filters Manager - Glomart CRM{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold mb-2">
                        <i class="bi bi-funnel text-primary me-3"></i>
                        Data Filters Manager
                    </h2>
                    <p class="text-muted mb-0">Configure data access filters and manage dropdown restrictions</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#createFilterModal">
                        <i class="bi bi-plus-circle me-2"></i>Create Filter
                    </button>
                    <a href="{% url 'authentication:field_permissions_dashboard' %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Search and Quick Stats -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-modern p-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <label class="form-label">Search Filters</label>
                        <input type="text" class="form-control" name="search" placeholder="Search by filter name, type, or model">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Filter by Type</label>
                        <select class="form-select" name="filter_type">
                            <option value="">All Types</option>
                            <option value="user_based">User-based</option>
                            <option value="role_based">Role-based</option>
                            <option value="department_based">Department-based</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-outline-primary w-100">
                            <i class="bi bi-search me-1"></i>Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card gradient-bg-primary text-white">
                <div class="stat-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number">{{ data_filters_count|default:12 }}</div>
                            <div class="stat-label">Data Filters</div>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-filter"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card gradient-bg-success text-white">
                <div class="stat-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number">{{ dropdown_restrictions_count|default:8 }}</div>
                            <div class="stat-label">Dropdown Restrictions</div>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-list"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card gradient-bg-warning text-white">
                <div class="stat-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number">{{ profile_scopes_count|default:6 }}</div>
                            <div class="stat-label">Profile Scopes</div>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stat-card gradient-bg-info text-white">
                <div class="stat-card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number">{{ dynamic_dropdowns_count|default:15 }}</div>
                            <div class="stat-label">Dynamic Dropdowns</div>
                        </div>
                        <div class="stat-icon">
                            <i class="bi bi-gear"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card-modern">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs card-header-tabs bg-light" id="filterTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="data-filters-tab" data-bs-toggle="tab" data-bs-target="#data-filters" type="button" role="tab">
                    <i class="bi bi-filter me-2"></i>Data Filters
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dropdown-restrictions-tab" data-bs-toggle="tab" data-bs-target="#dropdown-restrictions" type="button" role="tab">
                    <i class="bi bi-list me-2"></i>Dropdown Restrictions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-scopes-tab" data-bs-toggle="tab" data-bs-target="#profile-scopes" type="button" role="tab">
                    <i class="bi bi-people me-2"></i>Profile Scopes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dynamic-dropdowns-tab" data-bs-toggle="tab" data-bs-target="#dynamic-dropdowns" type="button" role="tab">
                    <i class="bi bi-gear me-2"></i>Dynamic Dropdowns
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content p-4" id="filterTabContent">
            <!-- Data Filters Tab -->
            <div class="tab-pane fade show active" id="data-filters" role="tabpanel">
                <div class="row">
                    {% for filter in data_filters|default:""|slice:":6" %}
                    <div class="col-xl-4 col-lg-6 mb-3">
                        <div class="card-modern h-100 interactive">
                            <div class="card-header bg-gradient-primary text-white">
                                <h6 class="mb-0">{{ filter.name|default:"User-based Property Filter" }}</h6>
                                <small class="opacity-75">{{ filter.description|default:"Filter properties based on user assignment" }}</small>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-primary">{{ filter.filter_type|default:"user_based" }}</span>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editFilter('{{ filter.id|default:1 }}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFilter('{{ filter.id|default:1 }}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-muted small">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-database me-2"></i>
                                        <span>{{ filter.target_model|default:"Property" }}</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-people me-2"></i>
                                        <span>{{ filter.profiles_count|default:3 }} profiles affected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <!-- Sample Data Filters -->
                    <div class="col-xl-4 col-lg-6 mb-3">
                        <div class="card-modern h-100 interactive">
                            <div class="card-header bg-gradient-primary text-white">
                                <h6 class="mb-0">User-based Property Filter</h6>
                                <small class="opacity-75">Filter properties based on user assignment</small>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-primary">user_based</span>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editFilter(1)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFilter(1)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-muted small">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-database me-2"></i>
                                        <span>Property</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-people me-2"></i>
                                        <span>3 profiles affected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-lg-6 mb-3">
                        <div class="card-modern h-100 interactive">
                            <div class="card-header bg-gradient-success text-white">
                                <h6 class="mb-0">Role-based Lead Filter</h6>
                                <small class="opacity-75">Filter leads based on user role</small>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-success">role_based</span>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editFilter(2)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFilter(2)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-muted small">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-database me-2"></i>
                                        <span>Lead</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-people me-2"></i>
                                        <span>2 profiles affected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-lg-6 mb-3">
                        <div class="card-modern h-100 interactive">
                            <div class="card-header bg-gradient-warning text-white">
                                <h6 class="mb-0">Department Project Filter</h6>
                                <small class="opacity-75">Filter projects by department access</small>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="badge bg-warning">department_based</span>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editFilter(3)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFilter(3)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="text-muted small">
                                    <div class="d-flex align-items-center mb-1">
                                        <i class="bi bi-database me-2"></i>
                                        <span>Project</span>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-people me-2"></i>
                                        <span>4 profiles affected</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Dropdown Restrictions Tab -->
            <div class="tab-pane fade" id="dropdown-restrictions" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6 mb-3">
                        <div class="card-modern h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-building text-primary me-2"></i>
                                    Property Type Restrictions
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Commercial specialists see only commercial property types</p>
                                <div class="d-flex flex-wrap gap-1 mb-3">
                                    <span class="badge bg-primary">Office</span>
                                    <span class="badge bg-primary">Retail</span>
                                    <span class="badge bg-primary">Warehouse</span>
                                    <span class="badge bg-primary">Industrial</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editDropdownRestriction(1)">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDropdownRestriction(1)">
                                        <i class="bi bi-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="card-modern h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-house text-success me-2"></i>
                                    Residential Property Types
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Residential specialists see only residential types</p>
                                <div class="d-flex flex-wrap gap-1 mb-3">
                                    <span class="badge bg-success">Apartment</span>
                                    <span class="badge bg-success">Villa</span>
                                    <span class="badge bg-success">Townhouse</span>
                                    <span class="badge bg-success">Studio</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editDropdownRestriction(2)">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDropdownRestriction(2)">
                                        <i class="bi bi-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="card-modern h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-geo-alt text-warning me-2"></i>
                                    Location Restrictions
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Regional agents see only their assigned areas</p>
                                <div class="d-flex flex-wrap gap-1 mb-3">
                                    <span class="badge bg-warning">Downtown</span>
                                    <span class="badge bg-warning">Business Bay</span>
                                    <span class="badge bg-warning">Marina</span>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editDropdownRestriction(3)">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDropdownRestriction(3)">
                                        <i class="bi bi-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Scopes Tab -->
            <div class="tab-pane fade" id="profile-scopes" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Profile</th>
                                <th>Data Scope</th>
                                <th>Restrictions Applied</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary rounded-circle p-2 me-3">
                                            <i class="bi bi-building text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">Commercial Property Specialist</div>
                                            <small class="text-muted">Handles commercial properties</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary">Commercial Only</span>
                                </td>
                                <td>
                                    <small class="text-muted">Property types, locations, price ranges</small>
                                </td>
                                <td>
                                    <span class="badge bg-success">Active</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success rounded-circle p-2 me-3">
                                            <i class="bi bi-house text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">Residential Property Specialist</div>
                                            <small class="text-muted">Handles residential properties</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-success">Residential Only</span>
                                </td>
                                <td>
                                    <small class="text-muted">Property types, areas, client segments</small>
                                </td>
                                <td>
                                    <span class="badge bg-success">Active</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="bg-warning rounded-circle p-2 me-3">
                                            <i class="bi bi-person text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">Lead Manager</div>
                                            <small class="text-muted">Manages leads and conversions</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-warning">All Leads</span>
                                </td>
                                <td>
                                    <small class="text-muted">Status filters, source restrictions</small>
                                </td>
                                <td>
                                    <span class="badge bg-success">Active</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil me-1"></i>Edit
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Dynamic Dropdowns Tab -->
            <div class="tab-pane fade" id="dynamic-dropdowns" role="tabpanel">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Dynamic Dropdowns</strong> - Configure how dropdown values change based on user profiles and data context.
                </div>
                
                <div class="row">
                    <div class="col-lg-4 mb-3">
                        <div class="card-modern h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-building text-primary me-2"></i>
                                    Property Type
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Values change based on specialist type</p>
                                <div class="mb-2">
                                    <strong class="small">Commercial:</strong>
                                    <div class="text-muted small">Office, Retail, Warehouse</div>
                                </div>
                                <div class="mb-3">
                                    <strong class="small">Residential:</strong>
                                    <div class="text-muted small">Apartment, Villa, Studio</div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-gear me-1"></i>Configure
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-3">
                        <div class="card-modern h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-geo-alt text-success me-2"></i>
                                    Location
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Filtered by user's assigned region</p>
                                <div class="mb-2">
                                    <strong class="small">Region A:</strong>
                                    <div class="text-muted small">Downtown, Marina</div>
                                </div>
                                <div class="mb-3">
                                    <strong class="small">Region B:</strong>
                                    <div class="text-muted small">Suburbs, Industrial</div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-gear me-1"></i>Configure
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-3">
                        <div class="card-modern h-100">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-person text-warning me-2"></i>
                                    Lead Source
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">Based on user's channel access</p>
                                <div class="mb-2">
                                    <strong class="small">Digital:</strong>
                                    <div class="text-muted small">Website, Social Media</div>
                                </div>
                                <div class="mb-3">
                                    <strong class="small">Traditional:</strong>
                                    <div class="text-muted small">Referral, Walk-in</div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-gear me-1"></i>Configure
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Create Filter Modal -->
<div class="modal fade" id="createFilterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle me-2"></i>Create New Data Filter
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createFilterForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Filter Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Filter Type</label>
                            <select class="form-select" name="filter_type" required>
                                <option value="">Choose type...</option>
                                <option value="user_based">User-based</option>
                                <option value="role_based">Role-based</option>
                                <option value="department_based">Department-based</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Target Model</label>
                            <select class="form-select" name="target_model" required>
                                <option value="">Choose model...</option>
                                <option value="Property">Property</option>
                                <option value="Lead">Lead</option>
                                <option value="Project">Project</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Profiles</label>
                            <select class="form-select" name="profiles" multiple>
                                <option value="1">Commercial Property Specialist</option>
                                <option value="2">Residential Property Specialist</option>
                                <option value="3">Lead Manager</option>
                                <option value="4">Sales Representative</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Filter Criteria (JSON)</label>
                        <textarea class="form-control" name="criteria" rows="4" placeholder='{"field": "assigned_to", "operator": "equals", "value": "$user_id"}'></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-gradient" onclick="saveFilter()">
                    <i class="bi bi-check-circle me-1"></i>Create Filter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Filter Modal -->
<div class="modal fade" id="editFilterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil me-2"></i>Edit Data Filter
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editFilterForm">
                    <input type="hidden" id="editFilterId" name="filter_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Profile</label>
                            <select class="form-select" id="editProfile" name="profile_id" required>
                                {% for profile in profiles %}
                                <option value="{{ profile.id }}">{{ profile.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Module</label>
                            <select class="form-select" id="editModule" name="module_id" required>
                                {% for module in modules %}
                                <option value="{{ module.id }}">{{ module.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Filter Name</label>
                        <input type="text" class="form-control" id="editFilterName" name="name" required>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Model Name</label>
                            <input type="text" class="form-control" id="editModelName" name="model_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Filter Type</label>
                            <select class="form-select" id="editFilterType" name="filter_type" required>
                                <option value="include">Include Only</option>
                                <option value="exclude">Exclude</option>
                                <option value="conditional">Conditional</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Filter Conditions (JSON)</label>
                        <textarea class="form-control" id="editFilterConditions" name="filter_conditions" rows="3" placeholder='{"field": "value"}'></textarea>
                    </div>
                    
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active">
                            <label class="form-check-label" for="editIsActive">
                                Active (filter is enforced)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-gradient" onclick="updateFilter()">
                    <i class="bi bi-check-circle me-1"></i>Update Filter
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editFilter(filterId) {
    // Fetch filter data for editing
    fetch(`/field-permissions/data-filters/${filterId}/edit/`)
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Populate edit form
                document.getElementById('editFilterId').value = data.id;
                document.getElementById('editProfile').value = data.profile_id || '';
                document.getElementById('editModule').value = data.module_id || '';
                document.getElementById('editFilterName').value = data.name || '';
                document.getElementById('editDescription').value = data.description || '';
                document.getElementById('editModelName').value = data.model_name || '';
                document.getElementById('editFilterType').value = data.filter_type || 'include';
                document.getElementById('editFilterConditions').value = JSON.stringify(data.filter_conditions || {}, null, 2);
                document.getElementById('editIsActive').checked = data.is_active || false;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editFilterModal'));
                modal.show();
            } else {
                alert('Error loading filter data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading filter data');
        });
}

function updateFilter() {
    const form = document.getElementById('editFilterForm');
    const formData = new FormData(form);
    const filterId = document.getElementById('editFilterId').value;
    
    let filterConditions;
    try {
        filterConditions = JSON.parse(document.getElementById('editFilterConditions').value);
    } catch (e) {
        alert('Invalid JSON in filter conditions');
        return;
    }
    
    const data = {
        profile_id: formData.get('profile_id'),
        module_id: formData.get('module_id'),
        name: formData.get('name'),
        description: formData.get('description'),
        model_name: formData.get('model_name'),
        filter_type: formData.get('filter_type'),
        filter_conditions: filterConditions,
        is_active: document.getElementById('editIsActive').checked
    };
    
    fetch(`/field-permissions/data-filters/${filterId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Refresh the page to show updated data
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating filter');
    });
}

function deleteFilter(filterId) {
    if (confirm('Are you sure you want to delete this filter? This action cannot be undone.')) {
        fetch(`/field-permissions/data-filters/${filterId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload(); // Refresh the page to show updated data
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting filter');
        });
    }
}

function editDropdownRestriction(restrictionId) {
    // Fetch restriction data for editing
    fetch(`/field-permissions/dropdown-restrictions/${restrictionId}/edit/`)
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Create a simplified edit interface
                const newName = prompt('Enter restriction name:', data.name || '');
                const newFieldName = prompt('Enter field name:', data.field_name || '');
                const newAllowedValues = prompt('Enter allowed values (comma-separated):', 
                    Array.isArray(data.allowed_values) ? data.allowed_values.join(', ') : '');
                const isActive = confirm('Should this restriction be active?');
                
                if (newName && newFieldName) {
                    // Update the restriction
                    const updateData = {
                        name: newName,
                        field_name: newFieldName,
                        allowed_values: newAllowedValues ? newAllowedValues.split(',').map(v => v.trim()) : [],
                        is_active: isActive,
                        profile_id: data.profile_id,
                        module_id: data.module_id,
                        source_model: data.source_model || '',
                        source_field: data.source_field || '',
                        display_field: data.display_field || ''
                    };
                    
                    fetch(`/field-permissions/dropdown-restrictions/${restrictionId}/edit/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(updateData)
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(result.message);
                            location.reload();
                        } else {
                            alert(result.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error updating restriction');
                    });
                }
            } else {
                alert('Error loading restriction data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading restriction data');
        });
}

function deleteDropdownRestriction(restrictionId) {
    if (confirm('Are you sure you want to delete this dropdown restriction? This action cannot be undone.')) {
        fetch(`/field-permissions/dropdown-restrictions/${restrictionId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting restriction');
        });
    }
}

function saveFilter() {
    const form = document.getElementById('createFilterForm');
    const formData = new FormData(form);
    
    const data = {
        profile_id: formData.get('profile_id'),
        module_id: formData.get('module_id'),
        field_name: formData.get('field_name'),
        filter_condition: formData.get('filter_condition'),
        filter_value: formData.get('filter_value'),
        is_active: document.getElementById('isActive').checked
    };
    
    fetch('/field-permissions/data-filters/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Refresh the page to show new data
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating filter');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}

<!-- Floating Action Button -->
<button class="create-filter-btn" data-bs-toggle="modal" data-bs-target="#createFilterModal" title="Create New Filter">
    <i class="fas fa-plus"></i>
</button>

<!-- Edit Filter Modal -->
<div class="modal fade" id="editFilterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Data Filter</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editFilterForm">
                    <input type="hidden" id="editFilterId" name="filter_id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Profile</label>
                            <select class="form-select" id="editProfile" name="profile_id" required>
                                {% for profile in profiles %}
                                <option value="{{ profile.id }}">{{ profile.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Module</label>
                            <select class="form-select" id="editModule" name="module_id" required>
                                {% for module in modules %}
                                <option value="{{ module.id }}">{{ module.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Filter Name</label>
                        <input type="text" class="form-control" id="editFilterName" name="name" required>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Model Name</label>
                            <input type="text" class="form-control" id="editModelName" name="model_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Filter Type</label>
                            <select class="form-select" id="editFilterType" name="filter_type" required>
                                <option value="include">Include Only</option>
                                <option value="exclude">Exclude</option>
                                <option value="conditional">Conditional</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Filter Conditions (JSON)</label>
                        <textarea class="form-control" id="editFilterConditions" name="filter_conditions" rows="3" placeholder='{"field": "value"}'></textarea>
                    </div>
                    
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive" name="is_active">
                            <label class="form-check-label" for="editIsActive">
                                Active (filter is enforced)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateFilter()">Update Filter</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function editFilter(filterId) {
    // Fetch filter data for editing
    fetch(`/field-permissions/data-filters/${filterId}/edit/`)
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Populate edit form
                document.getElementById('editFilterId').value = data.id;
                document.getElementById('editProfile').value = data.profile_id || '';
                document.getElementById('editModule').value = data.module_id || '';
                document.getElementById('editFilterName').value = data.name || '';
                document.getElementById('editDescription').value = data.description || '';
                document.getElementById('editModelName').value = data.model_name || '';
                document.getElementById('editFilterType').value = data.filter_type || 'include';
                document.getElementById('editFilterConditions').value = JSON.stringify(data.filter_conditions || {}, null, 2);
                document.getElementById('editIsActive').checked = data.is_active || false;
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editFilterModal'));
                modal.show();
            } else {
                alert('Error loading filter data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading filter data');
        });
}

function updateFilter() {
    const form = document.getElementById('editFilterForm');
    const formData = new FormData(form);
    const filterId = document.getElementById('editFilterId').value;
    
    let filterConditions;
    try {
        filterConditions = JSON.parse(document.getElementById('editFilterConditions').value);
    } catch (e) {
        alert('Invalid JSON in filter conditions');
        return;
    }
    
    const data = {
        profile_id: formData.get('profile_id'),
        module_id: formData.get('module_id'),
        name: formData.get('name'),
        description: formData.get('description'),
        model_name: formData.get('model_name'),
        filter_type: formData.get('filter_type'),
        filter_conditions: filterConditions,
        is_active: document.getElementById('editIsActive').checked
    };
    
    fetch(`/field-permissions/data-filters/${filterId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Refresh the page to show updated data
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating filter');
    });
}

function deleteFilter(filterId) {
    if (confirm('Are you sure you want to delete this filter? This action cannot be undone.')) {
        fetch(`/field-permissions/data-filters/${filterId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload(); // Refresh the page to show updated data
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting filter');
        });
    }
}

function editDropdownRestriction(restrictionId) {
    // Fetch restriction data for editing
    fetch(`/field-permissions/dropdown-restrictions/${restrictionId}/edit/`)
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                // Create a simplified edit interface
                const newName = prompt('Enter restriction name:', data.name || '');
                const newFieldName = prompt('Enter field name:', data.field_name || '');
                const newAllowedValues = prompt('Enter allowed values (comma-separated):', 
                    Array.isArray(data.allowed_values) ? data.allowed_values.join(', ') : '');
                const isActive = confirm('Should this restriction be active?');
                
                if (newName && newFieldName) {
                    // Update the restriction
                    const updateData = {
                        name: newName,
                        field_name: newFieldName,
                        allowed_values: newAllowedValues ? newAllowedValues.split(',').map(v => v.trim()) : [],
                        is_active: isActive,
                        profile_id: data.profile_id,
                        module_id: data.module_id,
                        source_model: data.source_model || '',
                        source_field: data.source_field || '',
                        display_field: data.display_field || ''
                    };
                    
                    fetch(`/field-permissions/dropdown-restrictions/${restrictionId}/edit/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify(updateData)
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert(result.message);
                            location.reload();
                        } else {
                            alert(result.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error updating restriction');
                    });
                }
            } else {
                alert('Error loading restriction data');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading restriction data');
        });
}

function deleteDropdownRestriction(restrictionId) {
    if (confirm('Are you sure you want to delete this dropdown restriction? This action cannot be undone.')) {
        fetch(`/field-permissions/dropdown-restrictions/${restrictionId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting restriction');
        });
    }
}

function saveFilter() {
    const form = document.getElementById('createFilterForm');
    const formData = new FormData(form);
    
    const data = {
        profile_id: formData.get('profile_id'),
        module_id: formData.get('module_id'),
        field_name: formData.get('field_name'),
        filter_condition: formData.get('filter_condition'),
        filter_value: formData.get('filter_value'),
        is_active: document.getElementById('isActive').checked
    };
    
    fetch('/field-permissions/data-filters/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Refresh the page to show new data
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating filter');
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}