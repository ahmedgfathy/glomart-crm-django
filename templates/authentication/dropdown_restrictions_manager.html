{% extends 'base.html' %}
{% load static %}

{% block title %}Dropdown Restrictions Manager{% endblock %}

{% block extra_css %}
<style>
    .restriction-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        transition: transform 0.3s ease;
    }
    .restriction-card:hover {
        transform: translateY(-2px);
    }
    .restriction-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
    }
    .restriction-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f1f3f4;
    }
    .restriction-item:last-child {
        border-bottom: none;
        border-radius: 0 0 15px 15px;
    }
    .field-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 500;
        background-color: #e9ecef;
        color: #495057;
    }
    .profile-chip {
        display: inline-block;
        background-color: #007bff;
        color: white;
        padding: 0.25rem 0.5rem;
        margin: 0.1rem;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    .values-container {
        max-height: 150px;
        overflow-y: auto;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 0.75rem;
        margin-top: 0.5rem;
    }
    .value-item {
        display: inline-block;
        background-color: #28a745;
        color: white;
        padding: 0.25rem 0.5rem;
        margin: 0.1rem;
        border-radius: 12px;
        font-size: 0.75rem;
        position: relative;
    }
    .value-item .remove-value {
        margin-left: 0.5rem;
        cursor: pointer;
        opacity: 0.7;
    }
    .value-item .remove-value:hover {
        opacity: 1;
    }
    .stats-overview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }
    .quick-action-card {
        background: white;
        border: 2px dashed #dee2e6;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .quick-action-card:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    .search-box {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        margin-bottom: 2rem;
    }
    .search-box:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
</style>
{% endblock %}

{% block body_content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Dropdown Restrictions Manager</h1>
                    <p class="text-muted">Configure dropdown value restrictions based on user profiles</p>
                </div>
                <div>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createRestrictionModal">
                        <i class="fas fa-plus"></i> Create Restriction
                    </button>
                    <a href="{% url 'authentication:field_permissions_dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-overview">
        <div class="row">
            <div class="col-md-3 text-center">
                <h2 class="mb-0">{{ total_restrictions|default:15 }}</h2>
                <small>Total Restrictions</small>
            </div>
            <div class="col-md-3 text-center">
                <h2 class="mb-0">{{ active_restrictions|default:12 }}</h2>
                <small>Active Restrictions</small>
            </div>
            <div class="col-md-3 text-center">
                <h2 class="mb-0">{{ affected_fields|default:8 }}</h2>
                <small>Affected Fields</small>
            </div>
            <div class="col-md-3 text-center">
                <h2 class="mb-0">{{ covered_profiles|default:6 }}</h2>
                <small>Covered Profiles</small>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" class="form-control search-box" id="searchRestrictions" placeholder="Search restrictions by field name, model, or profile...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterByModel">
                <option value="">All Models</option>
                <option value="Property">Property</option>
                <option value="Lead">Lead</option>
                <option value="Project">Project</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterByProfile">
                <option value="">All Profiles</option>
                <option value="commercial">Commercial Specialist</option>
                <option value="residential">Residential Specialist</option>
                <option value="lead_manager">Lead Manager</option>
                <option value="sales_rep">Sales Representative</option>
            </select>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="quick-action-card" onclick="createPropertyTypeRestriction()">
                <i class="fas fa-building fa-2x text-primary mb-2"></i>
                <h6>Property Type</h6>
                <small class="text-muted">Restrict property types by specialist</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="quick-action-card" onclick="createLocationRestriction()">
                <i class="fas fa-map-marker-alt fa-2x text-success mb-2"></i>
                <h6>Location</h6>
                <small class="text-muted">Restrict locations by region</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="quick-action-card" onclick="createStatusRestriction()">
                <i class="fas fa-tasks fa-2x text-warning mb-2"></i>
                <h6>Status</h6>
                <small class="text-muted">Restrict status options by role</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="quick-action-card" data-bs-toggle="modal" data-bs-target="#createRestrictionModal">
                <i class="fas fa-plus fa-2x text-info mb-2"></i>
                <h6>Custom</h6>
                <small class="text-muted">Create custom restriction</small>
            </div>
        </div>
    </div>

    <!-- Restrictions List -->
    <div class="row" id="restrictionsList">
        <!-- Property Type Restrictions -->
        <div class="col-md-6 col-lg-4 restriction-item" data-model="Property" data-field="property_type">
            <div class="restriction-card">
                <div class="restriction-header">
                    <h5 class="mb-1"><i class="fas fa-building"></i> Property Type</h5>
                    <small class="opacity-75">Commercial vs Residential Specialists</small>
                </div>
                <div class="restriction-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="field-badge">Property.property_type</span>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="editRestriction(1)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRestriction(1)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <strong>Profiles:</strong><br>
                        <span class="profile-chip">Commercial Specialist</span>
                        <span class="profile-chip">Residential Specialist</span>
                    </div>
                    
                    <div class="mb-2">
                        <strong>Allowed Values:</strong>
                        <div class="values-container">
                            <span class="value-item">Office <span class="remove-value">&times;</span></span>
                            <span class="value-item">Retail <span class="remove-value">&times;</span></span>
                            <span class="value-item">Warehouse <span class="remove-value">&times;</span></span>
                            <span class="value-item">Apartment <span class="remove-value">&times;</span></span>
                            <span class="value-item">Villa <span class="remove-value">&times;</span></span>
                        </div>
                    </div>
                    
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> Updated 2 days ago
                    </small>
                </div>
            </div>
        </div>

        <!-- Location Restrictions -->
        <div class="col-md-6 col-lg-4 restriction-item" data-model="Property" data-field="location">
            <div class="restriction-card">
                <div class="restriction-header">
                    <h5 class="mb-1"><i class="fas fa-map-marker-alt"></i> Location</h5>
                    <small class="opacity-75">Regional Access Control</small>
                </div>
                <div class="restriction-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="field-badge">Property.location</span>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="editRestriction(2)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRestriction(2)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <strong>Profiles:</strong><br>
                        <span class="profile-chip">Regional Agent A</span>
                        <span class="profile-chip">Regional Agent B</span>
                    </div>
                    
                    <div class="mb-2">
                        <strong>Allowed Values:</strong>
                        <div class="values-container">
                            <span class="value-item">Downtown <span class="remove-value">&times;</span></span>
                            <span class="value-item">Business Bay <span class="remove-value">&times;</span></span>
                            <span class="value-item">Marina <span class="remove-value">&times;</span></span>
                            <span class="value-item">JLT <span class="remove-value">&times;</span></span>
                        </div>
                    </div>
                    
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> Updated 1 week ago
                    </small>
                </div>
            </div>
        </div>

        <!-- Lead Status Restrictions -->
        <div class="col-md-6 col-lg-4 restriction-item" data-model="Lead" data-field="status">
            <div class="restriction-card">
                <div class="restriction-header">
                    <h5 class="mb-1"><i class="fas fa-tasks"></i> Lead Status</h5>
                    <small class="opacity-75">Role-based Status Access</small>
                </div>
                <div class="restriction-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="field-badge">Lead.status</span>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="editRestriction(3)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRestriction(3)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <strong>Profiles:</strong><br>
                        <span class="profile-chip">Lead Manager</span>
                        <span class="profile-chip">Sales Rep</span>
                    </div>
                    
                    <div class="mb-2">
                        <strong>Allowed Values:</strong>
                        <div class="values-container">
                            <span class="value-item">New <span class="remove-value">&times;</span></span>
                            <span class="value-item">Contacted <span class="remove-value">&times;</span></span>
                            <span class="value-item">Qualified <span class="remove-value">&times;</span></span>
                            <span class="value-item">Converted <span class="remove-value">&times;</span></span>
                        </div>
                    </div>
                    
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> Updated 3 days ago
                    </small>
                </div>
            </div>
        </div>

        <!-- Project Category Restrictions -->
        <div class="col-md-6 col-lg-4 restriction-item" data-model="Project" data-field="category">
            <div class="restriction-card">
                <div class="restriction-header">
                    <h5 class="mb-1"><i class="fas fa-layer-group"></i> Project Category</h5>
                    <small class="opacity-75">Department-based Access</small>
                </div>
                <div class="restriction-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="field-badge">Project.category</span>
                        <div>
                            <button class="btn btn-sm btn-outline-light" onclick="editRestriction(4)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRestriction(4)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <strong>Profiles:</strong><br>
                        <span class="profile-chip">Project Manager</span>
                        <span class="profile-chip">Developer</span>
                    </div>
                    
                    <div class="mb-2">
                        <strong>Allowed Values:</strong>
                        <div class="values-container">
                            <span class="value-item">Residential Development <span class="remove-value">&times;</span></span>
                            <span class="value-item">Commercial Development <span class="remove-value">&times;</span></span>
                            <span class="value-item">Mixed Use <span class="remove-value">&times;</span></span>
                        </div>
                    </div>
                    
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> Updated 5 days ago
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Restriction Modal -->
<div class="modal fade" id="createRestrictionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Dropdown Restriction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createRestrictionForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Target Model</label>
                            <select class="form-select" name="model" required onchange="updateFieldOptions()">
                                <option value="">Choose model...</option>
                                <option value="Property">Property</option>
                                <option value="Lead">Lead</option>
                                <option value="Project">Project</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Field Name</label>
                            <select class="form-select" name="field" required>
                                <option value="">Choose field...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Restriction Name</label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., Commercial Property Types" required>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="2" placeholder="Brief description of this restriction"></textarea>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Affected Profiles</label>
                        <select class="form-select" name="profiles" multiple required>
                            <option value="commercial_specialist">Commercial Property Specialist</option>
                            <option value="residential_specialist">Residential Property Specialist</option>
                            <option value="lead_manager">Lead Manager</option>
                            <option value="sales_representative">Sales Representative</option>
                            <option value="project_manager">Project Manager</option>
                        </select>
                        <small class="text-muted">Hold Ctrl/Cmd to select multiple profiles</small>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Allowed Values</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newValue" placeholder="Enter a value">
                            <button type="button" class="btn btn-outline-secondary" onclick="addValue()">Add</button>
                        </div>
                        <div id="valuesList" class="mt-2">
                            <!-- Added values will appear here -->
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                            <label class="form-check-label" for="isActive">
                                Active (restriction is enforced)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveRestriction()">Create Restriction</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allowedValues = [];

function updateFieldOptions() {
    const model = document.querySelector('select[name="model"]').value;
    const fieldSelect = document.querySelector('select[name="field"]');
    
    fieldSelect.innerHTML = '<option value="">Choose field...</option>';
    
    const fieldOptions = {
        'Property': [
            {value: 'property_type', text: 'Property Type'},
            {value: 'location', text: 'Location'},
            {value: 'status', text: 'Status'},
            {value: 'category', text: 'Category'}
        ],
        'Lead': [
            {value: 'status', text: 'Status'},
            {value: 'source', text: 'Source'},
            {value: 'priority', text: 'Priority'},
            {value: 'type', text: 'Type'}
        ],
        'Project': [
            {value: 'category', text: 'Category'},
            {value: 'status', text: 'Status'},
            {value: 'type', text: 'Type'},
            {value: 'priority', text: 'Priority'}
        ]
    };
    
    if (fieldOptions[model]) {
        fieldOptions[model].forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            fieldSelect.appendChild(optionElement);
        });
    }
}

function addValue() {
    const input = document.getElementById('newValue');
    const value = input.value.trim();
    
    if (value && !allowedValues.includes(value)) {
        allowedValues.push(value);
        updateValuesList();
        input.value = '';
    }
}

function removeValue(value) {
    allowedValues = allowedValues.filter(v => v !== value);
    updateValuesList();
}

function updateValuesList() {
    const container = document.getElementById('valuesList');
    container.innerHTML = allowedValues.map(value => 
        `<span class="value-item me-1 mb-1">${value} <span class="remove-value" onclick="removeValue('${value}')">&times;</span></span>`
    ).join('');
}

function createPropertyTypeRestriction() {
    // Pre-fill modal for property type restriction
    document.querySelector('select[name="model"]').value = 'Property';
    updateFieldOptions();
    document.querySelector('select[name="field"]').value = 'property_type';
    document.querySelector('input[name="name"]').value = 'Property Type Restriction';
    document.querySelector('textarea[name="description"]').value = 'Restrict property types based on specialist expertise';
    
    allowedValues = ['Office', 'Retail', 'Warehouse', 'Apartment', 'Villa', 'Studio'];
    updateValuesList();
    
    const modal = new bootstrap.Modal(document.getElementById('createRestrictionModal'));
    modal.show();
}

function createLocationRestriction() {
    // Pre-fill modal for location restriction
    document.querySelector('select[name="model"]').value = 'Property';
    updateFieldOptions();
    document.querySelector('select[name="field"]').value = 'location';
    document.querySelector('input[name="name"]').value = 'Location Restriction';
    document.querySelector('textarea[name="description"]').value = 'Restrict locations based on regional assignments';
    
    allowedValues = ['Downtown', 'Business Bay', 'Marina', 'JLT', 'DIFC'];
    updateValuesList();
    
    const modal = new bootstrap.Modal(document.getElementById('createRestrictionModal'));
    modal.show();
}

function createStatusRestriction() {
    // Pre-fill modal for status restriction
    document.querySelector('select[name="model"]').value = 'Lead';
    updateFieldOptions();
    document.querySelector('select[name="field"]').value = 'status';
    document.querySelector('input[name="name"]').value = 'Lead Status Restriction';
    document.querySelector('textarea[name="description"]').value = 'Restrict lead status options based on user role';
    
    allowedValues = ['New', 'Contacted', 'Qualified', 'Converted', 'Lost'];
    updateValuesList();
    
    const modal = new bootstrap.Modal(document.getElementById('createRestrictionModal'));
    modal.show();
}

function editRestriction(restrictionId) {
    alert('Edit restriction functionality would be implemented here for restriction ID: ' + restrictionId);
}

function deleteRestriction(restrictionId) {
    if (confirm('Are you sure you want to delete this restriction?')) {
        alert('Delete restriction functionality would be implemented here for restriction ID: ' + restrictionId);
    }
}

function saveRestriction() {
    const form = document.getElementById('createRestrictionForm');
    const formData = new FormData(form);
    
    // Add allowed values to form data
    formData.append('allowed_values', JSON.stringify(allowedValues));
    
    // Here you would normally send the data to the server
    alert('Restriction creation functionality would be implemented here');
    
    // Close modal and reset
    const modal = bootstrap.Modal.getInstance(document.getElementById('createRestrictionModal'));
    modal.hide();
    form.reset();
    allowedValues = [];
    updateValuesList();
}

// Search functionality
document.getElementById('searchRestrictions').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const restrictions = document.querySelectorAll('.restriction-item');
    
    restrictions.forEach(restriction => {
        const text = restriction.textContent.toLowerCase();
        restriction.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
});

// Filter functionality
document.getElementById('filterByModel').addEventListener('change', function() {
    const selectedModel = this.value;
    const restrictions = document.querySelectorAll('.restriction-item');
    
    restrictions.forEach(restriction => {
        if (!selectedModel || restriction.dataset.model === selectedModel) {
            restriction.style.display = 'block';
        } else {
            restriction.style.display = 'none';
        }
    });
});

// Allow Enter key to add values
document.getElementById('newValue').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addValue();
    }
});
</script>
{% endblock %}