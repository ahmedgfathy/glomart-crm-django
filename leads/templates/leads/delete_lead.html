{% extends 'app_layout.html' %}
{% load static %}

{% block title %}Delete Lead - {{ lead.full_name }} - Glomart CRM{% endblock %}

{% block extra_css %}
<style>
.delete-card {
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.danger-header {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    padding: 2rem;
    border-radius: 12px 12px 0 0;
    text-align: center;
}

.danger-icon {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto 1rem;
}

.warning-box {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 1rem;
    margin: 1.5rem 0;
}

.lead-info {
    background: #f8fafc;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1.5rem 0;
    border-left: 4px solid #3b82f6;
}

.consequence-list {
    list-style: none;
    padding: 0;
}

.consequence-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
}

.consequence-list li:last-child {
    border-bottom: none;
}

.consequence-list li i {
    color: #ef4444;
    margin-right: 0.5rem;
}

.confirmation-checkbox {
    background: #fff7ed;
    border: 1px solid #fed7aa;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.deletion-form {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'leads:leads_list' %}">Leads</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'leads:lead_detail' lead.id %}">{{ lead.full_name }}</a></li>
                    <li class="breadcrumb-item active">Delete</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Delete Confirmation -->
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <div class="delete-card">
                <!-- Danger Header -->
                <div class="danger-header">
                    <div class="danger-icon">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <h2 class="h4 mb-2">Delete Lead</h2>
                    <p class="mb-0 opacity-90">This action cannot be undone</p>
                </div>

                <div class="p-4">
                    <h5 class="text-danger mb-3">
                        <i class="bi bi-trash me-2"></i>Are you sure you want to delete this lead?
                    </h5>

                    <!-- Lead Information -->
                    <div class="lead-info">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <strong>Name:</strong><br>
                                <span class="text-muted">{{ lead.full_name }}</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Email:</strong><br>
                                <span class="text-muted">{{ lead.email }}</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Status:</strong><br>
                                <span class="badge" style="background-color: {{ lead.status.color }};">{{ lead.status.name }}</span>
                            </div>
                            <div class="col-md-6">
                                <strong>Created:</strong><br>
                                <span class="text-muted">{{ lead.created_at|date:"M d, Y" }}</span>
                            </div>
                            {% if lead.phone %}
                            <div class="col-md-6">
                                <strong>Phone:</strong><br>
                                <span class="text-muted">{{ lead.phone }}</span>
                            </div>
                            {% endif %}
                            {% if lead.company %}
                            <div class="col-md-6">
                                <strong>Company:</strong><br>
                                <span class="text-muted">{{ lead.company }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Warning -->
                    <div class="warning-box">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill text-warning me-2 fs-5"></i>
                            <strong>Warning: This action is permanent and cannot be undone!</strong>
                        </div>
                    </div>

                    <!-- What will be deleted -->
                    <h6 class="fw-bold text-danger mb-3">The following data will be permanently deleted:</h6>
                    <ul class="consequence-list">
                        <li>
                            <i class="bi bi-person-x"></i>
                            Lead contact information and basic details
                        </li>
                        <li>
                            <i class="bi bi-journal-x"></i>
                            All notes associated with this lead ({{ lead.notes_count }} notes)
                        </li>
                        <li>
                            <i class="bi bi-clock-history"></i>
                            Activity history and timeline ({{ lead.activities_count }} activities)
                        </li>
                        <li>
                            <i class="bi bi-file-earmark-x"></i>
                            Uploaded documents and files ({{ lead.documents_count }} documents)
                        </li>
                        <li>
                            <i class="bi bi-tag-x"></i>
                            Tags and categorization data
                        </li>
                        <li>
                            <i class="bi bi-graph-down"></i>
                            Lead scoring and interaction history
                        </li>
                    </ul>

                    <!-- Alternatives -->
                    <div class="alert alert-info mt-4">
                        <h6 class="alert-heading">
                            <i class="bi bi-lightbulb me-2"></i>Consider these alternatives:
                        </h6>
                        <ul class="mb-0">
                            <li>Mark the lead as "Inactive" or "Closed" instead of deleting</li>
                            <li>Archive the lead to preserve data while removing from active lists</li>
                            <li>Convert the lead to a different status if circumstances change</li>
                        </ul>
                    </div>

                    <!-- Confirmation Form -->
                    <div class="deletion-form">
                        <form method="POST" id="deleteForm">
                            {% csrf_token %}
                            
                            <!-- Confirmation Checkbox -->
                            <div class="confirmation-checkbox">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                                    <label class="form-check-label fw-semibold" for="confirmDelete">
                                        I understand that this action is permanent and cannot be undone
                                    </label>
                                </div>
                            </div>

                            <!-- Type confirmation -->
                            <div class="mb-3">
                                <label for="confirmText" class="form-label fw-semibold">
                                    Type <code>DELETE</code> to confirm:
                                </label>
                                <input type="text" class="form-control" id="confirmText" placeholder="Type DELETE" required>
                                <div class="form-text">This helps prevent accidental deletions.</div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-3 justify-content-end">
                                <a href="{% url 'leads:lead_detail' lead.id %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-danger" id="deleteBtn" disabled>
                                    <i class="bi bi-trash me-2"></i>Delete Lead Permanently
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Additional Actions -->
                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="fw-bold mb-3">Alternative Actions:</h6>
                        <div class="d-flex gap-2 flex-wrap">
                            <a href="{% url 'leads:edit_lead' lead.id %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-pencil me-2"></i>Edit Lead Instead
                            </a>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="changeStatus('inactive')">
                                <i class="bi bi-pause-circle me-2"></i>Mark as Inactive
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="archiveLead()">
                                <i class="bi bi-archive me-2"></i>Archive Lead
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmCheckbox = document.getElementById('confirmDelete');
    const confirmText = document.getElementById('confirmText');
    const deleteBtn = document.getElementById('deleteBtn');
    const deleteForm = document.getElementById('deleteForm');

    function checkFormValidity() {
        const isChecked = confirmCheckbox.checked;
        const isTextCorrect = confirmText.value.toUpperCase() === 'DELETE';
        
        deleteBtn.disabled = !(isChecked && isTextCorrect);
        
        if (isChecked && isTextCorrect) {
            deleteBtn.classList.remove('btn-danger');
            deleteBtn.classList.add('btn-danger');
        }
    }

    confirmCheckbox.addEventListener('change', checkFormValidity);
    confirmText.addEventListener('input', checkFormValidity);

    // Form submission with final confirmation
    deleteForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (confirm('FINAL CONFIRMATION: Are you absolutely sure you want to delete this lead? This action cannot be undone.')) {
            // Show loading state
            deleteBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Deleting...';
            deleteBtn.disabled = true;
            
            // Submit form
            this.submit();
        }
    });
});

// Alternative action functions
function changeStatus(status) {
    if (confirm('Change lead status to ' + status + ' instead of deleting?')) {
        fetch('{% url "leads:update_status_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                lead_id: '{{ lead.id }}',
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{% url "leads:lead_detail" lead.id %}';
            } else {
                alert('Failed to update status. Please try again.');
            }
        })
        .catch(error => {
            alert('An error occurred. Please try again.');
        });
    }
}

function archiveLead() {
    if (confirm('Archive this lead instead of deleting?')) {
        fetch('{% url "leads:archive_lead_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                lead_id: '{{ lead.id }}'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '{% url "leads:leads_list" %}';
            } else {
                alert('Failed to archive lead. Please try again.');
            }
        })
        .catch(error => {
            alert('An error occurred. Please try again.');
        });
    }
}
</script>
{% endblock %}